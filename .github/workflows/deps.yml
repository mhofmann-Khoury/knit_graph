name: Dependency Range Relaxation

on:
  # Run manually from the Actions tab
  workflow_dispatch:

jobs:
  relax-dependencies:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for potential PR creation

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # Use your minimum supported version

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: poetry install --with dev

      - name: Install poetry-relax
        run: poetry run pip install poetry-relax

      - name: Check current dependency constraints
        run: |
          echo "Current runtime dependencies:"
          poetry show --only main --tree

      - name: Run poetry-relax (dry-run)
        id: check_relax
        run: |
          echo "Checking what can be relaxed..."
          poetry run python -m poetry_relax --check --only main || echo "Dependencies can be relaxed"

      - name: Relax runtime dependencies only
        run: |
          echo "Relaxing runtime dependencies..."
          poetry run python -m poetry_relax --only main

      - name: Update lock file with relaxed dependencies
        run: poetry lock --no-update

      - name: Install with minimum versions
        run: |
          # Clear the virtual environment to force reinstall with minimum versions
          rm -rf .venv
          poetry env use python3.11
          poetry install --only main --sync

      - name: Run tests with minimum dependency versions
        run: |
          poetry install --with dev
          poetry run pytest tests/ -v

      - name: Show proposed changes
        run: |
          echo "Proposed dependency changes:"
          git diff pyproject.toml

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: relax dependency version constraints"
          title: "chore: relax dependency version constraints"
          body: |
            This PR relaxes the version constraints for runtime dependencies to their most permissive ranges while ensuring all tests pass.

            ## Changes
            - Updated `pyproject.toml` with relaxed dependency constraints
            - Verified that tests pass with minimum dependency versions

            ## Validation
            - ✅ Tests passed with minimum versions
            - ✅ Lock file updated successfully

            Please review the changes to ensure the relaxed constraints are appropriate for your use case.

            Generated by `poetry-relax` workflow.
          branch: deps/relax-constraints
          delete-branch: true
          labels: dependencies
