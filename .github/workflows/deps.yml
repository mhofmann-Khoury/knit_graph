name: Dependency Range Relaxation

on:
  # Run manually from the Actions tab
  workflow_dispatch:

jobs:
  relax-dependencies:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for potential PR creation

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'  # Use your minimum supported version

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: latest
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Cache Poetry dependencies
        uses: actions/cache@v4
        with:
          path: .venv
          key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        run: poetry install --with dev

      - name: Install poetry-relax
        run: |
          poetry self add poetry-relax
          poetry relax --help  # Verify installation

      - name: Check current dependency constraints
        run: |
          echo "Current runtime dependencies:"
          poetry show --only main --tree

      - name: Run poetry-relax (dry-run)
        id: check_relax
        run: |
          echo "Checking what can be relaxed..."
          poetry relax --check --only main || echo "Dependencies can be relaxed"

      - name: Relax runtime dependencies only
        run: |
          echo "Relaxing runtime dependencies..."
          poetry relax --only main

      - name: Update lock file with relaxed dependencies
        run: poetry lock --no-update

      - name: Install with minimum versions
        run: |
          # Clear the virtual environment to force reinstall with minimum versions
          rm -rf .venv
          poetry env use python3.11
          poetry install --only main --sync

      - name: Run tests with minimum dependency versions
        run: |
          poetry install --with dev
          poetry run pytest tests/ -v

      - name: Show proposed changes
        run: |
          echo "================================"
          echo "PROPOSED DEPENDENCY CHANGES"
          echo "================================"
          git diff pyproject.toml
          echo ""
          echo "================================"
          echo "SUMMARY"
          echo "================================"
          if git diff --quiet pyproject.toml; then
            echo "‚úÖ No changes needed - dependencies are already optimally relaxed"
          else
            echo "üìù Changes proposed above. Review and apply manually if desired."
            echo ""
            echo "To apply these changes:"
            echo "  1. Copy the diff above"
            echo "  2. Apply to your local pyproject.toml"
            echo "  3. Run: poetry lock --no-update"
            echo "  4. Run: poetry install"
            echo "  5. Run: poetry run pytest tests/ -v"
            echo "  6. Commit if tests pass"
          fi
